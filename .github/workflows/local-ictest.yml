# contract-e2e.yml
name: local-ictest

permissions:
  contents: write

on:
  push:
    # branches: [ main ]
  pull_request:

env:
    GO_VERSION: 1.21

jobs:
  build:
    runs-on: ubuntu-latest
    name: build
    steps:
      - name: Checkout interchaintest
        uses: actions/checkout@v4
        with:
            repository: strangelove-ventures/interchaintest
            path: interchaintest
            ref: 'v8.3.0'

      - name: Setup go ${{ env.GO_VERSION }}
        uses: actions/setup-go@v5
        with:
            go-version: ${{ env.GO_VERSION }}

      - name: build local-interchain
        run: cd interchaintest/local-interchain && go mod tidy && make install

      - name: Upload localic artifact
        uses: actions/upload-artifact@v3
        with:
          name: local-ic
          path: ~/go/bin/local-ic

  contract-e2e:
    needs: build
    name: contract e2e
    runs-on: ubuntu-latest
    steps:
      - name: checkout this repo (contracts)
        uses: actions/checkout@v4

      - name: Install latest toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          target: wasm32-unknown-unknown
          override: true

      - name: Download Tarball Artifact
        uses: actions/download-artifact@v3
        with:
          name: local-ic
          path: /tmp

      - name: Make local-ic executable
        run: chmod +x /tmp/local-ic

      - uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: install tar for cache
        run: |
          sudo apt-get update
          sudo apt-get install tar

      - name: set up cargo cache
        uses: actions/cache@v3
        with:
            path: |
                ~/.cargo/registry/bin/
                ~/.cargo/registry/index/
                ~/.cargo/registry/cache/
                ~/.cargo/git/db/
                target/
            key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: build artifacts
        timeout-minutes: 40
        run: |
          docker run --rm -v "$(pwd)":/code \
            --mount type=volume,source="$(basename "$(pwd)")_cache",target=/code/target \
            --mount type=volume,source=registry_cache,target=/usr/local/cargo/registry \
            cosmwasm/optimizer:0.16.0

      - name: upload contracts
        uses: actions/upload-artifact@v3
        with:
          name: contracts
          path: artifacts/

      - name: Start background ibc local-interchain
        run: cd local-interchaintest && ICTEST_HOME=./local-interchaintest /tmp/local-ic start neutron_gaia_osmosis_stride --api-port 42069 &

      - name: Run Rust E2E Script
        run: cd local-interchaintest && sleep 2m && cargo run --package local-ictest-e2e --bin local-ictest-e2e

      - name: Cleanup
        run: killall local-ic && exit 0
