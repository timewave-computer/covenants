name: Release Contracts

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4
      
      - name: Install cargo-run-script
        uses: actions-rs/cargo@v1
        with:
          command: install
          args: cargo-run-script
      
      - name: Run cargo optimize
        uses: actions-rs/cargo@v1
        with:
          command: run-script
          args: optimize
      
      - name: Export checksums to json
        run: |
          jq -cR 'split("  ") | {"code_hash":.[0], "contract":.[1]}' ./artifacts/checksums.txt | jq -cs '.' > checksums.json

      - name: Get release ID
        id: get_release
        uses: bruceadams/get-release@v1.3.2
        env:
          GITHUB_TOKEN: ${{ github.token }}
      
      - name: Upload optimized wasm
        uses: svenstaro/upload-release-action@2.9.0
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ./artifacts/*
          tag: ${{ github.ref }}
          overwrite: true
          file_glob: true
      
      - name: Get Timewave's CI Neutron deployment key (as in, private key)
        run: echo "${{ secrets.TW_CI_NEUTRON_KEY }}" > tw_ci_neutron.key
      
      - name: Install Neutron & import key
        run: |
          wget -O neutrond https://github.com/neutron-org/neutron/releases/download/v3.0.2/neutrond-linux-amd64
          chmod +x ./neutrond
          ./neutrond config chain-id neutrond-1
          ./neutrond config node https://neutron-rpc.publicnode.com:443
          ./neutrond config keyring-backend test
          echo ${{ secrets.TW_CI_NEUTRON_KEY_PASS }} | ./neutrond keys import tw_ci_neutron tw_ci_neutron.key

      - name: Deploy WASM contracts to Neutron
        run: |
          find ./artifacts -name \*.wasm -exec ./neutrond tx wasm store {} --from ${{ vars.TW_CI_NEUTRON_KEY_ADDR }} --gas auto --gas-prices 0.01untrn --gas-adjustment 1.3 --output json -y \; -exec sleep 5 \;
      
      - name: Get contract code IDs
        run: |
          sleep 5
          ./neutrond query wasm list-code --reverse --output json | jq -c '.code_infos[] | select(.creator == "${{ vars.TW_CI_NEUTRON_KEY_ADDR }}") | {code_id: .code_id, code_hash: .data_hash|ascii_downcase}' | jq -s . > code_ids.json

      - name: Join code IDs & checksums
        run: |
          jq '[JOIN(INDEX(input[]; .code_hash); .[]; .code_hash; add)]' checksums.json code_ids.json | jq '.[] | [.contract, .code_id] | @tsv' | column -t -s '\t' > contract_code_ids.txt
      
      - name: Append code IDs to release notes
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          body_path: contract_code_ids.txt
          append_body: true
          files: contract_code_ids.txt
